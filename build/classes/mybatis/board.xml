<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="board">
	
	<!-- 조회 -->
	<select id='totList' parameterType="String" resultType="Integer">
		select count(serial) totList from board 
		where 	subject 	like '%${_parameter}%'
		or 		doc		 	like '%${_parameter}%'
	</select>
	
	<select id="search" parameterType="board.Page" resultType="board.BoardVo">
		SELECT * FROM(
			SELECT rownum rno, m.* FROM (
				SELECT serial, pserial, lpad(' ', (LEVEL-1)*4, ' └ ') || subject subject, 
					mid, hit, to_char(mdate, 'rrrr-mm-dd') mdate,
					(SELECT count(serial) FROM boardAtt WHERE b.serial = pserial) attCnt 
			FROM BOARD b
			WHERE subject LIKE '%${findStr}%'
			OR doc LIKE '%${findStr}%'
			START WITH pserial IS NULL
			CONNECT BY PRIOR serial = pserial
			ORDER siblings BY serial DESC)m
		)WHERE rno BETWEEN #{startNo} AND #{endNo}
	</select>
	
	<!-- 삭제 -->
	<delete id="brd_delete" parameterType="board.BoardVo">
		DELETE FROM board WHERE serial = #{serial} AND mid = #{mid} AND pwd = #{pwd}
	</delete>
	
	<delete id="brdAtt_delete" parameterType="board.BoardVo">
		DELETE FROM boardAtt WHERE pserial = #{pSerial} AND sysAtt = #{sysAtt}
	</delete>

	<!-- 입력 -->
	<insert id="brd_insert" parameterType="board.BoardVo">
		INSERT INTO board(serial, pserial, subject, doc, mid, pwd, mdate, hit )
		values(seq_board.nextval, #{pSerial}, #{subject}, #{doc}, #{mid}, #{pwd}, #{sysDate}, #{hit})
	</insert>
	
	<insert id="brdAtt_insert" parameterType="board.BoardVo">
		INSERT INTO boardAtt(serial, pserial, oriAtt, sysAtt)
		values(seq_boardAtt.nextval, #{pSerial}, #{oriAtt}', #{sysAtt})
	</insert>
	
	<!-- 답글 -->
	<insert id="brd_repl" parameterType="board.BoardVo">
		INSERT INTO board(serial, pserial, subject, doc, mid, pwd, mdate, hit )
		values(seq_board.nextval, #{pSerial}, #{subject}, #{doc}, #{mid}, #{pwd}, #{sysDate}, #{hit})
	</insert>
	
	<insert id="brdAtt_repl" parameterType="board.BoardVo">
		INSERT INTO boardAtt(serial, pserial, oriAtt, sysAtt)
		values(seq_boardAtt.nextval, #{pSerial}, #{oriAtt}, #{sysAtt})
	</insert>

	<!-- 수정 -->
	<update id="brd_update" parameterType="board.BoardVo">
		UPDATE board SET subject = #{subject}, doc=#{doc}
		WHERE serial = #{serial} AND mid = #{mid} AND pwd = #{pwd}
	</update>
	
	<delete id="brdAtt_delete2" parameterType="board.BoardVo">
		DELETE FROM boardAtt WHERE sysAtt = #{sysAtt} AND pserial = #{pSerial}
	</delete>

	<insert id="brdAtt_insert2" parameterType="board.BoardVo">
		INSERT INTO boardAtt(serial, pserial, oriAtt, sysAtt)
		values(seq_boardAtt.nextval, #{pSerial}, #{oriAtt}, #{sysAtt});
	</insert>


</mapper>